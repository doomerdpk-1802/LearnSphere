name: Start Application on Server

on:
  push:
    branches:
      - master

jobs:
  deploy-app:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy to EC2
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PORT: ${{ vars.PORT }}
          JWT_SECRET_USER: ${{ secrets.JWT_SECRET_USER }}
          JWT_SECRET_ADMIN: ${{ secrets.JWT_SECRET_ADMIN }}
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@16.171.177.92<< EOF

          echo "ðŸ”¹ Cloning or updating repository"
          if [ -d "LearnSphere" ]; then
            cd LearnSphere
            git pull origin master
          else
            git clone https://github.com/doomerdpk-1802/LearnSphere.git
            cd LearnSphere
          fi

          echo "ðŸ”¹ Writing .env file"
          echo "DATABASE_URL=$DATABASE_URL" > .env
          echo "PORT=$PORT" >> .env
          echo "JWT_SECRET_USER=$JWT_SECRET_USER" >> .env
          echo "JWT_SECRET_ADMIN=$JWT_SECRET_ADMIN" >> .env
          cat .env | sed 's/=.*/=*****/'  

          echo "ðŸ”¹ Installing dependencies"
          npm install --legacy-peer-deps
          npm i pm2
          npx pm2 stop learnsphere || true
          npx pm2 start src/server.js --name learnsphere

          echo "ðŸ”¹ Updating NGINX config"
          sudo cp ./ops/nginx/nginx-vercel.conf /etc/nginx/nginx.conf
          sudo nginx -t
          sudo systemctl reload nginx

          echo "ðŸ”¹ Setting up SSL (Certbot)"
          if ! command -v certbot >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y certbot python3-certbot-nginx
          fi

          sudo certbot --nginx -d "learnsphere-vercel.api.deepak.cfd" --non-interactive --agree-tos --register-unsafely-without-email
          sudo certbot --nginx -d "bytebrain.api.deepak.cfd" --non-interactive --agree-tos --register-unsafely-without-email


          echo "âœ… Deployment complete!"
          EOF
